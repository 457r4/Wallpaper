#!/data/data/com.termux/files/usr/bin/zsh

termux-wake-lock

BLACK=$'\033[30m'
RED=$'\033[31m'
GREEN=$'\033[32m'
YELLOW=$'\033[33m'
BLUE=$'\033[34m'
MAGENTA=$'\033[35m'
CYAN=$'\033[36m'
WHITE=$'\033[37m'
CYAN=$'\033[36m' 

BOLD=$'\033[1m'
ITALIC=$'\033[3m'
UNDERLINE=$'\033[4m'

RESET=$'\033[0m'

APPNAME=$(basename "$0")
APP_DATA="$HOME/.local/share/$APPNAME"
METADATA="$APP_DATA/metadata.json"
UP_TO_DATE=false

[[ ! -d "$APP_DATA" ]] && mkdir -p "$APP_DATA"

update_fun() {
  while [[ "$UP_TO_DATE" == false ]]; do
    if [[ "$(termux-wifi-connectioninfo | jq '.bssid')" != "null" ]]; then 
      wget -O "$METADATA" "https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&date=$(date -u +"%Y-%m-%d")"
      wget -O "$APP_DATA/apod.jpg" "$(jq -r '.hdurl' "$METADATA")"
      [[ $? -eq 0 ]] && UP_TO_DATE=true
    else
      sleep 3600
    fi
  done
}

set_fun() {
  termux-wallpaper -l -f "$APP_DATA/apod.jpg"
  # termux-wallpaper -l -u "$(jq -r '.hdurl' "$METADATA")"
  [[ $? != 0 ]] && $selected
}

padding() {
  echo "$((${COLUMNS}/2 - ${#1}/2))"
}
center() {
  # First argument is content
  # Second argument is style
  p=$(padding $1)
  printf "%-${p}s%s\n" "" "${2}${1}${RESET}"
}
print_fun() {
  center "$(jq -r '.title' "$METADATA")" "${BOLD}${YELLOW}"
  
  explanation="  $(jq -r '.explanation' "$METADATA")"  
  width=$(($COLUMNS/2 - 2))
  lines=$(echo "$explanation" | fold -w $width)

  IFS="\n"
  lines_array=("${(@f)lines}")
  half=$((${#lines_array[@]}/2))

  for ((i = 1; i <= $half + 1; i++)); do
    printf " %-${WIDTH}s  %s\n" "$lines_array[i]" "$lines_array[half+i-1]"
  done
}

opt_count=0
while getopts ":usp" opt; do
  ((opt_count++))
  case "$opt" in
    u)
      selected="update_fun"
    ;;
    s)
      selected="set_fun"
    ;;
    p)
      selected="print_fun"
    ;;
    \?) 
      echo "Invalid option: -$OPTARG" >&2 
      exit -1 
    ;;
  esac
done

if (( opt_count = 0 )); then
  echo "You must pick at least one option: -u, -s or -p"
  exit -1 
elif (( opt_count > 1)); then
  echo "Too many options"
  exit -1 
fi

$selected

